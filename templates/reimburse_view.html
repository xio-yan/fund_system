{% extends "layout.html" %}
{% block content %}
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
  <!-- æ¨™é¡Œèˆ‡ç”³è«‹ç·¨è™Ÿ -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold">æ ¸éŠ·è©³æƒ…</h2>
    <span class="text-sm text-slate-500">æ ¸éŠ·ç·¨è™Ÿï¼š{{ r.id }}</span>
  </div>

  <!-- ğŸ”¹ åŸç”³è«‹å–®è³‡è¨Š -->
  {% if app_info %}
  <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
    <h3 class="text-lg font-semibold mb-2">åŸç”³è«‹è³‡æ–™</h3>
    <div class="grid md:grid-cols-2 gap-2 text-sm">
      <div><span class="text-slate-500">æ´»å‹•åç¨±ï¼š</span>{{ app_info.title }}</div>
      <div><span class="text-slate-500">ç”³è«‹å–®è™Ÿï¼š</span>{{ app_info.form_number }}</div>
      <div><span class="text-slate-500">ç”³è«‹å–®ä½ï¼š</span>{{ app_info.org_name }}</div>
      <div><span class="text-slate-500">ç”³è«‹äººï¼š</span>{{ app_info.applicant_name }}</div>
    </div>
  </div>
  {% endif %}

  <!-- ç‹€æ…‹èˆ‡é‡‘é¡æ‘˜è¦ -->
  <div class="grid md:grid-cols-2 gap-4 mb-4">
    <div>
      <div class="text-slate-500 text-sm">ç‹€æ…‹</div>
      <div class="font-medium">{{ status_label(r.status) }}</div>
    </div>
    <div>
      <div class="text-slate-500 text-sm">ç›®å‰éšæ®µ</div>
      <div class="font-medium">{{ step_label(r.current_step) }}</div>
    </div>
    <div>
      <div class="text-slate-500 text-sm">ç¸½é‡‘é¡</div>
      <div class="font-medium">{{ r.total_amount }}</div>
    </div>
    <div>
      <div class="text-slate-500 text-sm">æ ¸å®šé‡‘é¡</div>
      <div class="font-medium">{{ r.approved_amount or '-' }}</div>
    </div>
  </div>

  <!-- æ”¶æ“šæ˜ç´° -->
  <h3 class="text-lg font-semibold mt-6 mb-2">æ”¶æ“šæ˜ç´°</h3>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-500 border-b">
          <th class="py-2">æ¬¾é …</th>
          <th>ç”¨é€”</th>
          <th>é‡‘é¡</th>
          <th>æ”¶æ“šç…§ç‰‡</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr class="border-t hover:bg-slate-50">
          <td class="py-2">{{ it.item_name }}</td>
          <td>{{ it.purpose }}</td>
          <td>{{ it.amount }}</td>
          <td>
            {% if it.receipt_path %}
              <a href="/{{ it.receipt_path }}" target="_blank" class="text-blue-600 hover:underline">æŸ¥çœ‹</a>
            {% else %}
              <span class="text-slate-400">ç„¡</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- æ´»å‹•ç…§ç‰‡ -->
  <h3 class="text-lg font-semibold mt-6 mb-2">æ´»å‹•ç…§ç‰‡</h3>
  {% if photos | selectattr("type", "equalto", "activity") | list %}
  <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
    {% for p in photos if p.type == 'activity' %}
      <a href="/{{ p.path }}" target="_blank">
        <img src="/{{ p.path }}" class="rounded-lg border hover:opacity-80 transition">
      </a>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-slate-400 text-sm">å°šæœªä¸Šå‚³æ´»å‹•ç…§ç‰‡</div>
  {% endif %}

  <!-- å›é¥‹å–® -->
  <h3 class="text-lg font-semibold mt-6 mb-2">å›é¥‹å–®</h3>
  {% for p in photos if p.type == 'feedback' %}
    <a href="/{{ p.path }}" target="_blank">
      <img src="/{{ p.path }}" class="rounded-lg border w-64 hover:opacity-80 transition">
    </a>
  {% else %}
    <div class="text-slate-400 text-sm">å°šæœªä¸Šå‚³å›é¥‹å–®</div>
  {% endfor %}

  <!-- æª¢è¨äº‹é … -->
  <h3 class="text-lg font-semibold mt-6 mb-2">æª¢è¨äº‹é …</h3>
  <div class="bg-slate-50 rounded-lg p-3 whitespace-pre-line text-sm">
    {{ r.comment or 'ï¼ˆç„¡ï¼‰' }}
  </div>

  <!-- å¯©æ ¸æŒ‰éˆ• -->
  {% if user.id == r.applicant_id and r.status == 'rejected' %}
<div class="mt-6 text-right">
  <a href="{{ url_for('reimburse_edit', rid=r.id) }}"
     class="bg-amber-600 hover:bg-amber-700 text-white px-5 py-2 rounded-xl transition">
     é‡æ–°é€å‡ºæ ¸éŠ·
  </a>

<h3 class="text-lg font-semibold mt-6 mb-2">æ ¸éŠ·æ­·ç¨‹</h3>
{% set history = reviews %}
{% if history %}
<div class="bg-slate-50 rounded-lg border border-slate-200 p-3 text-sm space-y-2">
  {% for h in history %}
  <div>
    <div class="font-medium">{{ h.display_name }}ï¼ˆ{{ 'é€šé' if h.decision == 'approve' else 'é€€å›' }}ï¼‰</div>
    <div class="text-slate-600 whitespace-pre-line">{{ h.comment or 'ï¼ˆç„¡å‚™è¨»ï¼‰' }}</div>
    <div class="text-xs text-slate-400">{{ h.created_at }}</div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="text-slate-400 text-sm">å°šç„¡æ ¸éŠ·æ­·ç¨‹</div>
{% endif %}


</div>
{% endif %}
</div>
{% endblock %}
