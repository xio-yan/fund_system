
{% extends "layout.html" %}
{% block content %}
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold">管理後台</h2>
    <div class="flex items-center gap-2">
      <a href="{{ url_for('export_csv') }}" class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-700">匯出 CSV</a>
      <a href="{{ url_for('export_xlsx') }}" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500">匯出 Excel</a>
      <a href="{{ url_for('export_pdf') }}" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-500">匯出 PDF</a>
    </div>
  </div>

  <form method="get" class="grid lg:grid-cols-6 md:grid-cols-3 gap-3 mt-4">
    <div>
      <label class="block text-sm text-slate-600 mb-1">單位</label>
      <select name="org" class="w-full border border-slate-200 p-2 rounded-xl">
        <option value="">全部</option>
        {% for o in orgs %}
          <option value="{{ o.org_name }}" {% if org_sel==o.org_name %}selected{% endif %}>{{ o.org_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">狀態</label>
      <select name="status" class="w-full border border-slate-200 p-2 rounded-xl">
        <option value="">全部</option>
        {% for s in statuses %}
          <option value="{{ s.status }}" {% if status_sel==s.status %}selected{% endif %}>{{ s.status }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">審核階段</label>
      <select name="step" class="w-full border border-slate-200 p-2 rounded-xl">
        <option value="">全部</option>
        {% for s in steps %}
          <option value="{{ s.current_step }}" {% if step_sel==s.current_step %}selected{% endif %}>{{ s.current_step }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">關鍵字</label>
      <input type="text" name="q" value="{{ q or '' }}" class="w-full border border-slate-200 p-2 rounded-xl" placeholder="活動/申請人/單號">
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">起始日期</label>
      <input type="datetime-local" name="from" value="{{ date_from or '' }}" class="w-full border border-slate-200 p-2 rounded-xl">
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">結束日期</label>
      <input type="datetime-local" name="to" value="{{ date_to or '' }}" class="w-full border border-slate-200 p-2 rounded-xl">
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">最小金額</label>
      <input type="number" name="min" value="{{ min_amt or '' }}" class="w-full border border-slate-200 p-2 rounded-xl">
    </div>
    <div>
      <label class="block text-sm text-slate-600 mb-1">最大金額</label>
      <input type="number" name="max" value="{{ max_amt or '' }}" class="w-full border border-slate-200 p-2 rounded-xl">
    </div>
    <div class="flex items-end">
      <button class="px-4 py-2 rounded-xl bg-primary text-white hover:bg-secondary w-full">查詢</button>
    </div>
  </form>

  <div class="mt-6 overflow-x-auto">
    <table class="min-w-full text-sm border border-slate-200 rounded-xl">
      <thead class="bg-slate-100 text-slate-600">
        <tr>
          <th class="px-3 py-2 border-b">單號</th>
          <th class="px-3 py-2 border-b">單位</th>
          <th class="px-3 py-2 border-b">活動名稱</th>
          <th class="px-3 py-2 border-b">申請人</th>
          <th class="px-3 py-2 border-b">狀態</th>
          <th class="px-3 py-2 border-b">審核階段</th>
          <th class="px-3 py-2 border-b text-right">核定金額</th>
          <th class="px-3 py-2 border-b text-right">總金額</th>
          <th class="px-3 py-2 border-b">最後更新</th>
        </tr>
      </thead>
      <tbody>
        {% for a in applications %}
        <tr class="border-b hover:bg-slate-50">
          <td class="px-3 py-2"><a href="{{ url_for('view_application', aid=a.id) }}" class="text-blue-700 underline">{{ a.form_number }}</a></td>
          <td class="px-3 py-2">{{ a.org_name }}</td>
          <td class="px-3 py-2">{{ a.title }}</td>
          <td class="px-3 py-2">{{ a.applicant_name }}</td>
          <td class="px-3 py-2">{{ a.status }}</td>
          <td class="px-3 py-2">{{ a.current_step }}</td>
          <td class="px-3 py-2 text-right">{{ a.amount_approved or '' }}</td>
          <td class="px-3 py-2 text-right">{{ a.total_amount or '' }}</td>
          <td class="px-3 py-2">{{ (a.updated_at or '')[:16].replace('T',' ') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not applications %}
      <p class="text-slate-500 text-sm mt-4">查無資料</p>
    {% endif %}
  </div>

  {% if pages and pages > 1 %}
  <div class="flex items-center gap-2 mt-4">
    {% for p in range(1, pages+1) %}
      <a href="{{ url_for('admin_panel', org=org_sel, status=status_sel, step=step_sel, q=q, from=date_from, to=date_to, min=min_amt, max=max_amt, page=p) }}"
         class="px-3 py-1 rounded-lg border {{ 'bg-slate-800 text-white' if p==page else 'bg-white text-slate-700' }}">{{ p }}</a>
    {% endfor %}
    <span class="text-sm text-slate-500 ml-2">共 {{ total }} 筆</span>
  </div>
  {% endif %}
</div>
{% endblock %}
