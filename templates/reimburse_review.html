{% extends "layout.html" %}
{% block content %}
<div class="grid lg:grid-cols-3 gap-6">

  <!-- å·¦å´ï¼šæ ¸éŠ·è³‡æ–™ -->
  <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 lg:col-span-2">
    <h2 class="text-xl font-semibold mb-4">æ ¸éŠ·å¯©æ ¸</h2>

    <!-- ğŸ”¹ åŸç”³è«‹ç¶“è²»æ˜ç´° -->
{% if app_items %}
<div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-5">
  <h3 class="text-lg font-semibold mb-2">åŸç”³è«‹ç¶“è²»æ˜ç´°</h3>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-500 border-b">
          <th class="py-2">é …ç›®</th>
          <th>ç”¨é€”</th>
          <th>é‡‘é¡</th>
        </tr>
      </thead>
      <tbody>
        {% for ai in app_items %}
        <tr class="border-t hover:bg-slate-50">
          <td class="py-2">{{ ai.name }}</td>
          <td>{{ ai.purpose }}</td>
          <td>{{ ai.amount }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}


    <!-- ç‹€æ…‹è³‡è¨Š -->
    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <div>
        <div class="text-slate-500 text-sm">ç‹€æ…‹</div>
        <div class="font-medium">
          <span class="px-2 py-1 rounded-md text-xs
            {% if r.status=='completed' %} bg-emerald-50 text-emerald-700 border border-emerald-200
            {% elif r.status=='rejected' %} bg-rose-50 text-rose-700 border border-rose-200
            {% elif r.status in ['submitted','in_progress'] %} bg-sky-50 text-sky-700 border border-sky-200
            {% else %} bg-slate-50 text-slate-700 border border-slate-200 {% endif %}
          ">
            {{ status_label(r.status) }}
          </span>
        </div>
      </div>

      <div>
        <div class="text-slate-500 text-sm">ç›®å‰éšæ®µ</div>
        <div class="font-medium">{{ step_label(r.current_step) }}</div>
      </div>

      <div>
        <div class="text-slate-500 text-sm">ç¸½é‡‘é¡</div>
        <div class="font-medium">{{ r.total_amount }}</div>
      </div>

      <div>
        <div class="text-slate-500 text-sm">æ ¸å®šé‡‘é¡</div>
        <div class="font-medium">{{ r.approved_amount or '-' }}</div>
      </div>
    </div>

    <!-- æ”¶æ“šæ˜ç´° -->
    <h3 class="text-lg font-semibold mt-4 mb-2">æ”¶æ“šæ˜ç´°</h3>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500 border-b">
            <th class="py-2">æ¬¾é …</th>
            <th>ç”¨é€”</th>
            <th>é‡‘é¡</th>
            <th>æ”¶æ“š</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr class="border-t hover:bg-slate-50">
            <td class="py-2">{{ it.item_name }}</td>
            <td>{{ it.purpose }}</td>
            <td>{{ it.amount }}</td>
            <td>
              {% if it.receipt_path %}
                <a href="/{{ it.receipt_path }}" target="_blank" class="text-blue-600 hover:underline">æŸ¥çœ‹</a>
              {% else %}
                <span class="text-slate-400">ç„¡</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- æ´»å‹•ç…§ç‰‡ -->
    <h3 class="text-lg font-semibold mt-6 mb-2">æ´»å‹•ç…§ç‰‡</h3>
    {% set activity_photos = photos | selectattr("type", "equalto", "activity") | list %}
    {% if activity_photos %}
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      {% for p in activity_photos %}
        <a href="/{{ p.path }}" target="_blank">
          <img src="/{{ p.path }}" class="rounded-lg border hover:opacity-80 transition">
        </a>
      {% endfor %}
    </div>
    {% else %}
      <div class="text-slate-400 text-sm">å°šæœªä¸Šå‚³æ´»å‹•ç…§ç‰‡</div>
    {% endif %}

    <!-- å›é¥‹å–® -->
    <h3 class="text-lg font-semibold mt-6 mb-2">å›é¥‹å–®</h3>
    {% set feedbacks = photos | selectattr("type", "equalto", "feedback") | list %}
    {% if feedbacks %}
      {% for p in feedbacks %}
        <a href="/{{ p.path }}" target="_blank">
          <img src="/{{ p.path }}" class="rounded-lg border w-64 hover:opacity-80 transition">
        </a>
      {% endfor %}
    {% else %}
      <div class="text-slate-400 text-sm">å°šæœªä¸Šå‚³å›é¥‹å–®</div>
    {% endif %}

    <!-- æª¢è¨äº‹é … -->
    <h3 class="text-lg font-semibold mt-6 mb-2">æª¢è¨äº‹é …</h3>
    <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 whitespace-pre-line text-sm">
      {{ r.comment or 'ï¼ˆç„¡ï¼‰' }}
    </div>

    <!-- ğŸ”¹ æ ¸éŠ·æ­·ç¨‹ -->
    <h3 class="text-lg font-semibold mt-6 mb-2">æ ¸éŠ·æ­·ç¨‹</h3>
    {% if reviews %}
      <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm space-y-2">
        {% for rv in reviews %}
        <div>
          <div class="font-medium">{{ rv.display_name }}ï¼ˆ{{ 'é€šé' if rv.decision == 'approve' else 'é€€å›' }}ï¼‰</div>
          <div class="text-slate-600 whitespace-pre-line">{{ rv.comment or 'ï¼ˆç„¡å‚™è¨»ï¼‰' }}</div>
          <div class="text-xs text-slate-400">{{ rv.created_at }}</div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-slate-400 text-sm">å°šç„¡æ­·ç¨‹ç´€éŒ„</div>
    {% endif %}
  </section>

  <!-- å³å´ï¼šå¯©æ ¸è¡¨å–® -->
  <aside class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
    <form method="post" class="space-y-4" onsubmit="return confirmSubmit()">
      <div>
        <label class="block text-sm font-medium mb-1">å¯©æ ¸çµæœ</label>
        <select name="decision" class="w-full border p-2 rounded-lg">
          <option value="approve">é€šé</option>
          <option value="reject">ä¸é€šéï¼ˆé€€å›ï¼‰</option>
        </select>
      </div>

      {% if user.role == "parliament_chair" %}
      <div>
        <label class="block text-sm font-medium mb-1">æ ¸å®šé‡‘é¡ï¼ˆåƒ…è­°é•·å¡«å¯«ï¼‰</label>
        <input name="approved_amount" type="number" step="0.01" class="w-full border p-2 rounded-lg">
      </div>
      {% endif %}

      <div>
        <label class="block text-sm font-medium mb-1">å‚™è¨»ï¼é€€å›åŸå› </label>
        <textarea name="comment" rows="4" class="w-full border p-2 rounded-lg"></textarea>
      </div>

      <button type="submit"
              class="bg-emerald-600 hover:bg-emerald-700 text-white w-full py-3 rounded-xl transition">
        æäº¤å¯©æ ¸
      </button>
    </form>

    <div class="mt-5 text-sm text-slate-500">
      <p>ç›®å‰å¯©æ ¸è§’è‰²ï¼š<strong>{{ role_label(user.role) }}</strong></p>
      <p class="mt-1">ä¸‹ä¸€æ­¥å°‡è‡ªå‹•æµå‘ä¸‹ä¸€å±¤ç´šå¯©æ ¸ã€‚</p>
    </div>
  </aside>

</div>

<!-- âœ… ç¢ºèªå½ˆçª— -->
<script>
function confirmSubmit(){
  return confirm("ç¢ºå®šè¦é€å‡ºé€™æ¬¡å¯©æ ¸å—ï¼Ÿ");
}
</script>
{% endblock %}
