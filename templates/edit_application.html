{% extends "layout.html" %}
{% block content %}
<div class="grid gap-6 lg:grid-cols-3">
  <div class="lg:col-span-2 space-y-6">
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-feather="edit-3"></i> 修正申請（編號：{{ app.form_number }}）</h2>
      <form method="post" id="app-form">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">活動名稱</label>
            <input name="title" value="{{ app.title }}" class="w-full border border-slate-200 p-3 rounded-xl focus:border-secondary" required>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">協辦單位（非必填）</label>
            <input name="co_org" value="{{ app.co_org or '' }}" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">負責人班級</label>
            <input name="leader_class" value="{{ app.leader_class }}" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">負責人姓名</label>
            <input name="leader_name" value="{{ app.leader_name }}" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">開始時間</label>
            <input type="datetime-local" name="start_at" value="{{ app.start_at }}" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">結束時間</label>
            <input type="datetime-local" name="end_at" value="{{ app.end_at }}" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
        </div>
        <div class="grid md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">預計人數</label>
            <input type="number" name="expected_people" value="{{ app.expected_people }}" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">活動地點</label>
            <input name="location" value="{{ app.location }}" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">活動對象</label>
            <input name="target" value="{{ app.target }}" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm text-slate-600 mb-1">活動目的</label>
          <textarea name="purpose" class="w-full border border-slate-200 p-3 rounded-xl">{{ app.purpose }}</textarea>
        </div>

        <section class="mt-6">
          <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i data-feather="dollar-sign"></i> 經費項目</h3>
          <div id="line-items">
            {% for it in items %}
            <div class="mb-2 flex gap-2 items-center">
              <input name="item_name[]" value="{{ it.name }}" class="border border-slate-200 p-3 rounded-xl w-1/4" placeholder="款項名稱">
              <input name="item_purpose[]" value="{{ it.purpose }}" class="border border-slate-200 p-3 rounded-xl w-2/4" placeholder="用途">
              <input name="item_amount[]" value="{{ it.amount }}" type="number" step="0.01" class="border border-slate-200 p-3 rounded-xl w-1/6" placeholder="金額" oninput="recalc()">
              <button type="button" class="remove-item bg-rose-100 text-rose-700 px-2 py-2 rounded-xl">刪</button>
            </div>
            {% endfor %}
            {% if not items %}
            <div class="mb-2 flex gap-2 items-center">
              <input name="item_name[]" class="border border-slate-200 p-3 rounded-xl w-1/4" placeholder="款項名稱">
              <input name="item_purpose[]" class="border border-slate-200 p-3 rounded-xl w-2/4" placeholder="用途">
              <input name="item_amount[]" type="number" step="0.01" class="border border-slate-200 p-3 rounded-xl w-1/6" placeholder="金額" oninput="recalc()">
              <button type="button" class="remove-item bg-rose-100 text-rose-700 px-2 py-2 rounded-xl">刪</button>
            </div>
            {% endif %}
          </div>
          <div class="mt-2 flex items-center gap-4">
            <button type="button" id="add-item" class="inline-flex items-center gap-2 bg-slate-800 text-white px-3 py-2 rounded-xl"><i data-feather="plus"></i>新增款項</button>
            <span class="text-sm text-slate-600">送出後系統將重新計算總金額</span>
          </div>
        </section>

      

        <div class="mt-6 flex gap-3">
          <a href="{{ url_for('view_application', aid=app.id) }}" class="px-4 py-3 rounded-xl border border-slate-300 text-slate-700">取消</a>
          <button class="bg-primary hover:bg-secondary text-white px-5 py-3 rounded-xl inline-flex items-center gap-2"><i data-feather="send"></i> 重新送審</button>
        </div>
      </form>
    </section>
  </div>

  <aside class="space-y-6">
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="text-sm text-slate-500">目前狀態</div>
      <div class="mt-2"><span class="px-2 py-1 rounded-md text-xs bg-rose-50 text-rose-700 border border-rose-200">rejected</span> / {{ app.current_step }}</div>
      <p class="text-xs text-slate-500 mt-2">重新送出後，系統會依流程自動送往正確的下一關。</p>
    </section>
  </aside>
</div>

<script>
function recalc(){
  const amounts = Array.from(document.querySelectorAll('input[name="item_amount[]"]')).map(i => parseFloat(i.value||'0'));
  const s = amounts.reduce((a,b)=>a+b,0);
}
document.addEventListener('click', function(e){
  if(e.target && e.target.id==='add-item'){
    const c = document.getElementById('line-items');
    const div = document.createElement('div');
    div.className='mb-2 flex gap-2 items-center';
    div.innerHTML = '<input name="item_name[]" class="border border-slate-200 p-3 rounded-xl w-1/4" placeholder="款項名稱">'
                   +'<input name="item_purpose[]" class="border border-slate-200 p-3 rounded-xl w-2/4" placeholder="用途">'
                   +'<input name="item_amount[]" type="number" step="0.01" class="border border-slate-200 p-3 rounded-xl w-1/6" placeholder="金額" oninput="recalc()">'
                   +'<button type="button" class="remove-item bg-rose-100 text-rose-700 px-2 py-2 rounded-xl">刪</button>';
    c.appendChild(div);
  }
  if(e.target && e.target.classList.contains('remove-item')){
    e.target.closest('div.mb-2').remove(); recalc();
  }
});
</script>
{% endblock %}