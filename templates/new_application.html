{% extends "layout.html" %}
{% block content %}
<div class="grid gap-6 lg:grid-cols-3">
  <div class="lg:col-span-2 space-y-6">
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-feather="file-text"></i> 活動資訊</h2>
      <form method="post" onsubmit="return confirm('確定要送出此申請嗎？\n送出後將進入審核流程。');"id="app-form">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">活動名稱</label>
            <input name="title" class="w-full border border-slate-200 p-3 rounded-xl focus:border-secondary" required>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">協辦單位（非必填）</label>
            <input name="co_org" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">負責人班級</label>
            <input name="leader_class" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">負責人姓名</label>
            <input name="leader_name" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">開始時間</label>
            <input type="datetime-local" name="start_at" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">結束時間</label>
            <input type="datetime-local" name="end_at" class="w-full border border-slate-200 p-3 rounded-xl" required>
          </div>
        </div>
        <div class="grid md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">預計人數</label>
            <input type="number" name="expected_people" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">活動地點</label>
            <input name="location" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">活動對象</label>
            <input name="target" class="w-full border border-slate-200 p-3 rounded-xl">
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm text-slate-600 mb-1">活動目的</label>
          <textarea name="purpose" class="w-full border border-slate-200 p-3 rounded-xl"></textarea>
        </div>

        <section class="mt-6">
          <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i data-feather="dollar-sign"></i> 經費項目</h3>
          <div id="line-items">
            <div class="mb-2 flex gap-2 items-center">
              <input name="item_name[]" class="border border-slate-200 p-3 rounded-xl w-1/4" placeholder="款項名稱">
              <input name="item_purpose[]" class="border border-slate-200 p-3 rounded-xl w-2/4" placeholder="用途">
              <input name="item_amount[]" type="number" step="0.01" class="border border-slate-200 p-3 rounded-xl w-1/6" placeholder="金額" oninput="recalc()">
              <button type="button" class="remove-item bg-rose-100 text-rose-700 px-2 py-2 rounded-xl">刪</button>
            </div>
          </div>
          <div class="mt-2 flex items-center gap-4">
            <button type="button" id="add-item" class="inline-flex items-center gap-2 bg-slate-800 text-white px-3 py-2 rounded-xl"><i data-feather="plus"></i>新增款項</button>
            <span class="text-sm text-slate-600">總計：<span id="total" class="font-semibold">0</span></span>
          </div>
        </section>

        <div class="mt-6">
          <button class="bg-primary hover:bg-secondary text-white px-5 py-3 rounded-xl inline-flex items-center gap-2"><i data-feather="send"></i> 送出申請</button>
        </div>
      </form>
    </section>
  </div>

  <aside class="space-y-6">
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="text-sm text-slate-500">申請單位（固定）</div>
      <div class="mt-2 text-xl font-semibold">
        {% if user.role == 'org' and fixed_org %}
          {{ fixed_org.name }}
        {% elif user.role in ['union_president','union_finance','union_treasurer','union_other','parliament_chair'] %}
          學生會
        {% else %}
          （非申請角色）
        {% endif %}
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h4 class="font-semibold mb-2">小提醒</h4>
      <ul class="text-sm text-slate-600 list-disc pl-5 space-y-1">
        <li>請確認時間、金額、目的等資訊正確無誤再送出。</li>
        <li>送出後會依流程自動送審，不可跳關。</li>
        <li>退回後可於詳情頁再次編輯與重送。</li>
      </ul>
    </section>
  </aside>
</div>

<script>
function recalc(){
  const amounts = Array.from(document.querySelectorAll('input[name="item_amount[]"]')).map(i => parseFloat(i.value||'0'));
  const s = amounts.reduce((a,b)=>a+b,0);
  const el = document.getElementById('total');
  el.innerText = isNaN(s)?0:s.toFixed(2);
}
document.addEventListener('click', function(e){
  if(e.target && e.target.id==='add-item'){
    const c = document.getElementById('line-items');
    const div = document.createElement('div');
    div.className='mb-2 flex gap-2 items-center';
    div.innerHTML = '<input name="item_name[]" class="border border-slate-200 p-3 rounded-xl w-1/4" placeholder="款項名稱">'
                   +'<input name="item_purpose[]" class="border border-slate-200 p-3 rounded-xl w-2/4" placeholder="用途">'
                   +'<input name="item_amount[]" type="number" step="0.01" class="border border-slate-200 p-3 rounded-xl w-1/6" placeholder="金額" oninput="recalc()">'
                   +'<button type="button" class="remove-item bg-rose-100 text-rose-700 px-2 py-2 rounded-xl">刪</button>';
    c.appendChild(div);
  }
  if(e.target && e.target.classList.contains('remove-item')){
    e.target.closest('div.mb-2').remove(); recalc();
  }
});
</script>
{% endblock %}